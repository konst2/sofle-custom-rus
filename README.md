# Sofle Custom RU — прошивка для QMK с независимым от раскладки ОС расположением символов

Прошивка предназначена для эргономичной split-клавиатуры Sofle RGB v2 (MX) 
на контроллерах RP2040, ориентированной на многоязычную с английской и русской раскладками. Поддерживается автоматическое переключение
раскладки в ОС, эффективный ввод специальных символов через комбо, залипающие шифты, RGB-подсветка, OLED-дисплей.

## Требования к железу

Платы: Sofle RGB v2 проводная версия.  
Контроллеры: Pro Micro RP2040  
Дополнительно:  
2× OLED-дисплея  
2× энкодера  
RGB-светодиоды на кажой клавише  
Резистор на GP4 для автоматического определения стороны (левая/правая)  
Инструкция по сборке: [PandaKB Sofle Build Guide](https://pandakb.com/guides/sofle-rgb-mx-build-guide/)  
Плата для которой собрана прошивка была куплена в магазине `MiFuny`  

## Возможности прошивки

### Умное переключение раскладки (модифицированный lang_shift + Karabiner / AutoHotkey)

Прошивка использует модифицированную версию плагина [lang_shift](https://github.com/konst2/lang_shift-mac) в котором добавлен способ управления раскладкой методом `LANG_CHANGE_CARABINER` (решает проблему с рассинхронизацией и проскальзыванием символов другой раскладки).

#### Принцип работы

При необходимости переключения языка по клавише переключения раскладки или ввода символа который находится в неактивной раскладке, прошивка автоматически отправляет `F18` или `F19`, которые ОС интерпретируют как команду смены раскладки. Клавиши разные для каждого языка, что
решает проблему оригинального плагина рассинхронизации между клавиатурой и ОС которая возникала в недоработанной версии плагина -- текущий язык клавиатуры практически всегда совпадает с системным.

#### Настройка OS

- MacOS  
Установите [Karabiner-Elements](https://github.com/pqrs-org/Karabiner-Elements).  
Далее надо добавить 2 правила через  
Settings -> Complex Modification -> Add Your Own Rule:  
 1.  
```json
{
    "description": "F19 -> переключить на английский (даже с Shift/Ctrl и др.)",
    "manipulators": [
        {
            "from": {
                "key_code": "f19",
                "modifiers": { "optional": ["any"] }
            },
            "to": [{ "select_input_source": { "language": "en" } }],
            "type": "basic"
        }
    ]
}
```

 2.  
```json
{
    "description": "F18 -> переключить на русский (даже с Shift/Ctrl и др.)",
    "manipulators": [
        {
            "from": {
                "key_code": "f18",
                "modifiers": { "optional": ["any"] }
            },
            "to": [{ "select_input_source": { "language": "ru" } }],
            "type": "basic"
        }
    ]
}
```
>Для русского языка в macOS следует обязательно заменить раскладку на "Русский — PC", (вместо "Русский" установленный в системе по умолчанию). 

- Windows 11.  
Установить утилиту [Autohotkey V2](https://www.autohotkey.com/)  
В папке автозапуска Windows следует создать файл `lang_shift.ahk` в котором:  
```
; Переключение на английский по F19 (игнорируя модификаторы)
*$F19::{
    SetInputLang("00000409") ; en-US w11
}

; Переключение на русский по F18 (игнорируя модификаторы)
*$F18::{
    SetInputLang("00000419") ; ru-RU w11
}

; Функция установки раскладки (для AHK v2)
SetInputLang(LocaleID) {
    hWnd := WinGetID("A") ; активное окно
    threadID := DllCall("GetWindowThreadProcessId", "Ptr", hWnd, "Ptr", 0, "UInt")
    hkl := DllCall("LoadKeyboardLayout", "Str", LocaleID, "UInt", 1, "Ptr")
    if (!hkl)
        return
    ; Отправляем сообщение для смены раскладки в поток окна
    DllCall("PostMessage", "Ptr", -1, "UInt", 0x50, "Ptr", threadID, "Ptr", hkl)
}
```

>Тут `00000409` и `00000419` id русской и английской раскладок в системе.  Если вдруг возникнут проблемы их можно посмотреть в `PowerShell`  
```
Get-WinUserLanguageList | ForEach-Object {
    Write-Host "Язык: $($_.LanguageTag)"
    $_.InputMethodTips | ForEach-Object { Write-Host "  Раскладка: $_" }
}
```

- Linux.  
Аналогично, перехват F18/F19.  
F18 - переключение на русскую раскладку.  
F19 - переключение на английскую раскладку

### Раскладка слоёв.  

[Keyboard Layout Editor](https://www.keyboard-layout-editor.com/#/gists/26ca3f92825312924ce738406f96e0a4)

![Раскладка](soflekeyboard.png)

`Красный слой` `RAIZE` -- навигация.  
`Синий слой` `LOWER`-- знаки. Однако гораздо удобнее пользоваться комбо (см ниже) на которых сейчас все эти знаки есть, поэтому клавиша синего слоя перенесена подальше от большого пальца.  

TODO: добавить слой _ADJUST (настройка ОС, RGB)


## Комбо

Комбо активируются при одновременном (или почти одновременном) нажатии соседних клавиш.  



Горизонтальные комбо повторяют символьный слой — то есть спецсимволы, скобки, знаки препинания:  

![Комбо](combos.png)


Горизонтальные комбо настраиваются в раскладке - keymap.c  
TODO: 

Вертикальные комбо (соседние клавиши по вертикали) отдают соответсвующую Fx клавишу.  

Преимущества:  
- Не нужно переключаться на дополнительный слой — символ вводится одним движением;
- Идеально для программистов: !@#$%^&*() и другие символы доступны без модификаторов.
- Комбо работают в обеих раскладках (EN/RU)

## TriLayer

При одновременной активации слоев LOWER и RAISE автоматически активируется слой ADJUST для системных настроек.


## Залипающий Shift

Оба Shift работают так:  
- если Shift зажат как обычно, и во время его зажатия были введены какие-либо символы, то считаем, что это обычный Shift.  
- если Shift был однократно нажат, то он срабатывает к одной следующей клавише. Бывает удобно нажать перед заглавной буквой, если она одна. 

## Поддержка разных OS

Клавиша `S` (KC_CH_OS) на слое Ajust переключает OS. В зависимости от OS изменяется расположение клавиш `CMD` и `CTRL`, а так же изменяются клавиши для перемещения и удаления из следующего раздела

## Перемещение по словам и удаление по словам

В навигационном слое `RAIZE`:  

| Клавиша | Описание |
|---------|----------|
| `T`     | Удалить слово до курсора |
| `Y`     | Удалить слово после курсора |
| `G`     | На слово назад |
| `H`     | На слово вперёд |
| `B`     | В начало строки |
| `N`     | В конец строки |

Команды адаптированы под macOS и Windows и посылают на разных ОС разные комбинации.  

## Включение/выключение слоя навигации

Нажатие на правый энкодер включает или выключает слой навигации `RAIZE`

## RGB подсветка

Эффекты: Все встроеенные в оригинальный QMK  
Управление в слое `ADJUST`.  
| Клавиша | Описание |
|---------|----------|
| `1` | Включение / Выключение |
| `2` | Next |
| `3` | Prew |
| `4` | Hue+ |
| `5` | Hue- |
| `6` | Sat+ |
| `7` | Sat- |
| `8` | Val+ |
| `9` | Val- |
| `0` | Speed+ |
| `Backspace` | Speed- |

Текущий эффект отображается на OLED-дисплее (сокращённое имя до 5–6 символов). 



## OLED дисплеи

Отображаются:  
- Текущая раскладка (англиская, русская)  
- Логотип ОС (macOS, Windows, Linux)  
- Состояние RGB: включено / отключено и текущий эффект  
- Текущий слой (LOWER, RAISE, ADJUST)

## Энкодеры
Левый энкодер: 
- регулировка громкости (VOLU/VOLD).  
- нажатие - MUTE.  
  
Правый энкодер: 
- прокрутка страниц (PGUP/PGDN).  
- нажатие - включение слоя навигации.  


## Сборка и прошивка

TODO:

# Ссылки

Модифицированный плагин lang_shift
https://github.com/konst2/lang_shift-mac


Panda layouts:
https://github.com/PandaKBLab/QMK-firmware-for-keyboards/tree/main/sofle/sofle
